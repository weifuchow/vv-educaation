<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>VVCE è¯¾ä»¶æ¸²æŸ“å¼•æ“æ¼”ç¤º</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'PingFang SC', 'Hiragino Sans GB',
        'Microsoft YaHei', sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      display: flex;
      padding: 20px;
    }

    .container {
      display: flex;
      gap: 20px;
      width: 100%;
      max-width: 1400px;
      margin: 0 auto;
    }

    .main-panel {
      flex: 1;
      background: white;
      border-radius: 16px;
      padding: 30px;
      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
    }

    .debug-panel {
      width: 350px;
      background: white;
      border-radius: 16px;
      padding: 20px;
      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
      overflow-y: auto;
      max-height: calc(100vh - 40px);
    }

    h1 {
      color: #667eea;
      margin-bottom: 10px;
      font-size: 28px;
    }

    .subtitle {
      color: #666;
      margin-bottom: 30px;
      font-size: 14px;
    }

    .scene {
      min-height: 400px;
    }

    /* Node components */
    .node {
      margin-bottom: 20px;
      animation: fadeIn 0.3s ease-in;
    }

    @keyframes fadeIn {
      from {
        opacity: 0;
        transform: translateY(10px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    /* Dialog component */
    .dialog {
      background: #f8f9fa;
      border-left: 4px solid #667eea;
      padding: 20px;
      border-radius: 8px;
      margin-bottom: 20px;
    }

    .dialog-speaker {
      font-weight: bold;
      color: #667eea;
      margin-bottom: 8px;
      font-size: 14px;
    }

    .dialog-text {
      color: #333;
      line-height: 1.6;
      font-size: 16px;
    }

    /* Quiz component */
    .quiz {
      background: #fff;
      border: 2px solid #e1e4e8;
      border-radius: 12px;
      padding: 24px;
    }

    .quiz-question {
      font-size: 18px;
      font-weight: 600;
      color: #333;
      margin-bottom: 20px;
    }

    .quiz-options {
      display: flex;
      flex-direction: column;
      gap: 12px;
    }

    .quiz-option {
      padding: 16px 20px;
      border: 2px solid #e1e4e8;
      border-radius: 8px;
      cursor: pointer;
      transition: all 0.2s;
      font-size: 16px;
      background: white;
    }

    .quiz-option:hover {
      border-color: #667eea;
      background: #f8f9ff;
    }

    .quiz-option.selected {
      border-color: #667eea;
      background: #f0f4ff;
      font-weight: 600;
    }

    .quiz-option.correct {
      border-color: #28a745;
      background: #d4edda;
    }

    .quiz-option.incorrect {
      border-color: #dc3545;
      background: #f8d7da;
    }

    /* Button component */
    .button {
      padding: 14px 32px;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      border: none;
      border-radius: 8px;
      font-size: 16px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s;
      box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);
    }

    .button:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 20px rgba(102, 126, 234, 0.6);
    }

    .button:active {
      transform: translateY(0);
    }

    /* Toast */
    .toast {
      position: fixed;
      top: 20px;
      left: 50%;
      transform: translateX(-50%);
      background: #333;
      color: white;
      padding: 16px 24px;
      border-radius: 8px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
      z-index: 1000;
      animation: slideDown 0.3s ease-out;
    }

    @keyframes slideDown {
      from {
        opacity: 0;
        transform: translateX(-50%) translateY(-20px);
      }
      to {
        opacity: 1;
        transform: translateX(-50%) translateY(0);
      }
    }

    /* Debug panel */
    .debug-section {
      margin-bottom: 20px;
    }

    .debug-title {
      font-size: 14px;
      font-weight: 600;
      color: #667eea;
      margin-bottom: 10px;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .debug-content {
      background: #f8f9fa;
      padding: 12px;
      border-radius: 6px;
      font-family: 'Courier New', monospace;
      font-size: 12px;
      color: #333;
      white-space: pre-wrap;
      word-break: break-all;
    }

    .log-entry {
      padding: 8px;
      margin-bottom: 6px;
      border-radius: 4px;
      background: white;
      border-left: 3px solid #667eea;
      font-size: 11px;
    }

    .log-type {
      font-weight: bold;
      color: #667eea;
      text-transform: uppercase;
      font-size: 10px;
    }

    .log-message {
      color: #666;
      margin-top: 4px;
    }

    .score-display {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      padding: 20px;
      border-radius: 8px;
      text-align: center;
      margin-bottom: 20px;
    }

    .score-label {
      font-size: 12px;
      opacity: 0.9;
      margin-bottom: 5px;
    }

    .score-value {
      font-size: 32px;
      font-weight: bold;
    }

    .scene-info {
      background: #f0f4ff;
      padding: 12px;
      border-radius: 6px;
      margin-bottom: 20px;
      text-align: center;
      color: #667eea;
      font-weight: 600;
    }
  </style>
</head>
<body>
  <div class="container">
    <!-- Main content area -->
    <div class="main-panel">
      <h1>ğŸ“ VVè¯¾å ‚ - è¯¾ä»¶æ¸²æŸ“å¼•æ“æ¼”ç¤º</h1>
      <p class="subtitle">åŸºäºå£°æ˜å¼ DSL çš„äº¤äº’å¼è¯¾ä»¶å¼•æ“</p>

      <div id="scene-container" class="scene"></div>
    </div>

    <!-- Debug panel -->
    <div class="debug-panel">
      <div class="debug-section">
        <div class="debug-title">ğŸ“Š å½“å‰çŠ¶æ€</div>
        <div class="scene-info" id="current-scene">åœºæ™¯: åŠ è½½ä¸­...</div>

        <div class="score-display">
          <div class="score-label">å½“å‰å¾—åˆ†</div>
          <div class="score-value" id="score-display">0</div>
        </div>
      </div>

      <div class="debug-section">
        <div class="debug-title">ğŸ”§ å…¨å±€å˜é‡</div>
        <div class="debug-content" id="global-vars"></div>
      </div>

      <div class="debug-section">
        <div class="debug-title">ğŸ“ æœ€è¿‘æ—¥å¿—</div>
        <div id="logs-container"></div>
      </div>
    </div>
  </div>

  <script type="module">
    // Import VVCE Runtime from the built package
    import { VVCERuntime } from '../../packages/vvce-core/dist/index.mjs';

    // Sample course DSL - A simple math quiz
    const sampleCourse = {
      schema: 'vvce.dsl.v1',
      meta: {
        id: 'demo-math-quiz',
        version: '1.0.0',
        title: 'åŸºç¡€æ•°å­¦æµ‹éªŒ',
        author: 'VV Education'
      },
      globals: {
        vars: {
          score: 0,
          attempt: 0,
          nickname: 'å°æ˜'
        }
      },
      startSceneId: 'welcome',
      scenes: [
        {
          id: 'welcome',
          vars: { temp: 'initial' },
          nodes: [
            {
              id: 'welcome-dialog',
              type: 'Dialog',
              props: {
                speaker: 'VVè€å¸ˆ',
                text: 'ä½ å¥½ï¼Œ{{globals.vars.nickname}}ï¼æ¬¢è¿æ¥åˆ°VVè¯¾å ‚ã€‚ä»Šå¤©æˆ‘ä»¬æ¥åšä¸€ä¸ªç®€å•çš„æ•°å­¦æµ‹éªŒã€‚'
              }
            },
            {
              id: 'start-button',
              type: 'Button',
              props: {
                text: 'å¼€å§‹æµ‹éªŒ'
              }
            }
          ],
          triggers: [
            {
              on: { event: 'click', target: 'start-button' },
              then: [
                { action: 'gotoScene', sceneId: 'question1' }
              ]
            }
          ]
        },
        {
          id: 'question1',
          nodes: [
            {
              id: 'q1-dialog',
              type: 'Dialog',
              props: {
                speaker: 'VVè€å¸ˆ',
                text: 'ç¬¬ä¸€é¢˜æ¥äº†ï¼'
              }
            },
            {
              id: 'q1',
              type: 'QuizSingle',
              props: {
                question: '1 + 1 = ?',
                options: ['1', '2', '3', '4'],
                answerKey: '2'
              }
            },
            {
              id: 'submit1',
              type: 'Button',
              props: {
                text: 'æäº¤ç­”æ¡ˆ'
              }
            }
          ],
          triggers: [
            {
              on: { event: 'click', target: 'submit1' },
              if: [
                {
                  op: 'equals',
                  left: { ref: 'q1.state.selected' },
                  right: '2'
                }
              ],
              then: [
                { action: 'addScore', value: 10 },
                { action: 'toast', text: 'å›ç­”æ­£ç¡®ï¼+10åˆ†' },
                { action: 'delay', ms: 1500 },
                { action: 'gotoScene', sceneId: 'question2' }
              ],
              else: [
                { action: 'incVar', path: 'globals.vars.attempt', by: 1 },
                { action: 'toast', text: 'ç­”æ¡ˆä¸å¯¹å“¦ï¼Œå†æƒ³æƒ³ï½' }
              ]
            }
          ]
        },
        {
          id: 'question2',
          nodes: [
            {
              id: 'q2-dialog',
              type: 'Dialog',
              props: {
                speaker: 'VVè€å¸ˆ',
                text: 'åšå¾—ä¸é”™ï¼ç¬¬äºŒé¢˜ç¨å¾®éš¾ä¸€ç‚¹...'
              }
            },
            {
              id: 'q2',
              type: 'QuizSingle',
              props: {
                question: '5 Ã— 3 = ?',
                options: ['10', '12', '15', '18'],
                answerKey: '15'
              }
            },
            {
              id: 'submit2',
              type: 'Button',
              props: {
                text: 'æäº¤ç­”æ¡ˆ'
              }
            }
          ],
          triggers: [
            {
              on: { event: 'click', target: 'submit2' },
              if: [
                {
                  op: 'equals',
                  left: { ref: 'q2.state.selected' },
                  right: '15'
                }
              ],
              then: [
                { action: 'addScore', value: 20 },
                { action: 'toast', text: 'å¤ªæ£’äº†ï¼+20åˆ†' },
                { action: 'delay', ms: 1500 },
                { action: 'gotoScene', sceneId: 'result' }
              ],
              else: [
                { action: 'incVar', path: 'globals.vars.attempt', by: 1 },
                { action: 'toast', text: 'å†æƒ³æƒ³ï¼Œæç¤ºï¼š3ä¸ª5ç›¸åŠ æ˜¯å¤šå°‘ï¼Ÿ' }
              ]
            }
          ]
        },
        {
          id: 'result',
          nodes: [
            {
              id: 'result-dialog',
              type: 'Dialog',
              props: {
                speaker: 'VVè€å¸ˆ',
                text: 'å¤ªæ£’äº†ï¼{{globals.vars.nickname}}ï¼Œä½ å·²ç»å®Œæˆäº†æ‰€æœ‰é¢˜ç›®ï¼æœ€ç»ˆå¾—åˆ†ï¼š{{globals.vars.score}}åˆ†'
              }
            },
            {
              id: 'restart-button',
              type: 'Button',
              props: {
                text: 'é‡æ–°å¼€å§‹'
              }
            }
          ],
          triggers: [
            {
              on: { event: 'click', target: 'restart-button' },
              then: [
                { action: 'setVar', path: 'globals.vars.score', value: 0 },
                { action: 'setVar', path: 'globals.vars.attempt', value: 0 },
                { action: 'gotoScene', sceneId: 'welcome' }
              ]
            }
          ]
        }
      ]
    };

    // Simple component renderers
    class ComponentRenderer {
      constructor(runtime) {
        this.runtime = runtime;
        this.nodeStates = new Map();
      }

      renderDialog(node) {
        const { speaker, text } = node.props;
        const processedText = this.interpolateText(text);

        return `
          <div class="node dialog" data-node-id="${node.id}">
            ${speaker ? `<div class="dialog-speaker">${speaker}</div>` : ''}
            <div class="dialog-text">${processedText}</div>
          </div>
        `;
      }

      renderQuizSingle(node) {
        const { question, options } = node.props;
        const selected = this.nodeStates.get(node.id) || null;

        const optionsHtml = options.map((option, index) => {
          const isSelected = selected === option;
          return `
            <div class="quiz-option ${isSelected ? 'selected' : ''}"
                 data-node-id="${node.id}"
                 data-option="${option}">
              ${String.fromCharCode(65 + index)}. ${option}
            </div>
          `;
        }).join('');

        return `
          <div class="node quiz" data-node-id="${node.id}">
            <div class="quiz-question">${question}</div>
            <div class="quiz-options">
              ${optionsHtml}
            </div>
          </div>
        `;
      }

      renderButton(node) {
        const { text } = node.props;
        return `
          <div class="node">
            <button class="button" data-node-id="${node.id}">
              ${text}
            </button>
          </div>
        `;
      }

      interpolateText(text) {
        return text.replace(/\{\{(.+?)\}\}/g, (match, path) => {
          const trimmedPath = path.trim();
          const value = this.runtime.getState().globals.vars[trimmedPath.split('.').pop()];
          return value !== undefined ? value : match;
        });
      }

      renderNode(node) {
        switch (node.type) {
          case 'Dialog':
            return this.renderDialog(node);
          case 'QuizSingle':
            return this.renderQuizSingle(node);
          case 'Button':
            return this.renderButton(node);
          default:
            return `<div class="node">Unknown component: ${node.type}</div>`;
        }
      }
    }

    // UI Manager
    class UIManager {
      constructor(runtime, renderer) {
        this.runtime = runtime;
        this.renderer = renderer;
        this.sceneContainer = document.getElementById('scene-container');
        this.setupEventListeners();
      }

      setupEventListeners() {
        this.sceneContainer.addEventListener('click', (e) => {
          const target = e.target;

          // Handle button clicks
          if (target.classList.contains('button')) {
            const nodeId = target.dataset.nodeId;
            this.runtime.emitEvent({
              type: 'click',
              target: nodeId,
              payload: null,
              ts: Date.now()
            });
          }

          // Handle quiz option clicks
          if (target.classList.contains('quiz-option')) {
            const nodeId = target.dataset.nodeId;
            const option = target.dataset.option;

            // Update visual state
            const allOptions = this.sceneContainer.querySelectorAll(
              `.quiz-option[data-node-id="${nodeId}"]`
            );
            allOptions.forEach(opt => opt.classList.remove('selected'));
            target.classList.add('selected');

            // Update runtime state
            this.renderer.nodeStates.set(nodeId, option);
            this.runtime.store.set(`${nodeId}.state.selected`, option);

            // Emit change event
            this.runtime.emitEvent({
              type: 'change',
              target: nodeId,
              payload: option,
              ts: Date.now()
            });
          }
        });
      }

      renderScene(scene) {
        if (!scene || !scene.nodes) {
          this.sceneContainer.innerHTML = '<p>åœºæ™¯åŠ è½½ä¸­...</p>';
          return;
        }

        const html = scene.nodes.map(node => this.renderer.renderNode(node)).join('');
        this.sceneContainer.innerHTML = html;
      }

      showToast(text) {
        const existing = document.querySelector('.toast');
        if (existing) {
          existing.remove();
        }

        const toast = document.createElement('div');
        toast.className = 'toast';
        toast.textContent = text;
        document.body.appendChild(toast);

        setTimeout(() => {
          toast.remove();
        }, 2000);
      }

      updateDebugPanel() {
        const state = this.runtime.getState();

        // Update scene info
        document.getElementById('current-scene').textContent =
          `åœºæ™¯: ${state.scene.current || 'æœªçŸ¥'}`;

        // Update score
        document.getElementById('score-display').textContent =
          state.globals.vars.score || 0;

        // Update global vars
        document.getElementById('global-vars').textContent =
          JSON.stringify(state.globals.vars, null, 2);

        // Update logs
        const logs = this.runtime.getLogs().slice(-10).reverse();
        const logsHtml = logs.map(log => `
          <div class="log-entry">
            <div class="log-type">${log.type}</div>
            <div class="log-message">${log.message}</div>
          </div>
        `).join('');
        document.getElementById('logs-container').innerHTML = logsHtml;
      }
    }

    // Initialize application
    function init() {
      // Create runtime instance
      const runtime = new VVCERuntime({
        debug: true,
        onSceneChange: (sceneId) => {
          console.log('Scene changed to:', sceneId);
          const currentScene = runtime.course.scenes.find(s => s.id === sceneId);
          uiManager.renderScene(currentScene);
          uiManager.updateDebugPanel();
        },
        onStateChange: (state) => {
          console.log('State changed:', state);
          uiManager.updateDebugPanel();
        },
        onUIAction: (action) => {
          console.log('UI Action:', action);
          if (action.action === 'toast') {
            uiManager.showToast(action.text);
          }
          uiManager.updateDebugPanel();
        }
      });

      // Create renderer and UI manager
      const renderer = new ComponentRenderer(runtime);
      const uiManager = new UIManager(runtime, renderer);

      // Load and start course
      runtime.loadCourse(sampleCourse);
      runtime.start();

      // Initial render
      const startScene = runtime.course.scenes.find(s => s.id === runtime.course.startSceneId);
      uiManager.renderScene(startScene);
      uiManager.updateDebugPanel();

      // Expose to window for debugging
      window.vvceRuntime = runtime;
      window.uiManager = uiManager;

      console.log('VVCE Demo initialized! Access runtime via window.vvceRuntime');
    }

    // Start the application
    init();
  </script>
</body>
</html>

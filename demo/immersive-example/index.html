<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>VVè¯¾å ‚ - æ²‰æµ¸å¼äº¤äº’è¯¾ä»¶æ¼”ç¤º</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'PingFang SC', 'Hiragino Sans GB',
        'Microsoft YaHei', sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      display: flex;
      padding: 20px;
    }

    .container {
      display: flex;
      gap: 20px;
      width: 100%;
      max-width: 1400px;
      margin: 0 auto;
    }

    .main-panel {
      flex: 1;
      background: white;
      border-radius: 16px;
      padding: 30px;
      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
      position: relative;
      overflow: hidden;
    }

    .debug-panel {
      width: 350px;
      background: white;
      border-radius: 16px;
      padding: 20px;
      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
      overflow-y: auto;
      max-height: calc(100vh - 40px);
    }

    h1 {
      color: #667eea;
      margin-bottom: 10px;
      font-size: 28px;
    }

    .subtitle {
      color: #666;
      margin-bottom: 30px;
      font-size: 14px;
    }

    .scene {
      min-height: 500px;
    }

    /* Node components */
    .node {
      margin-bottom: 20px;
      animation: fadeIn 0.5s ease-in;
    }

    @keyframes fadeIn {
      from {
        opacity: 0;
        transform: translateY(10px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    /* Dialog component */
    .dialog {
      background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
      border-left: 4px solid #667eea;
      padding: 20px;
      border-radius: 12px;
      margin-bottom: 20px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }

    .dialog-speaker {
      font-weight: bold;
      color: #667eea;
      margin-bottom: 8px;
      font-size: 14px;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .dialog-speaker::before {
      content: 'ğŸ‘¨â€ğŸ«';
      font-size: 20px;
    }

    .dialog-text {
      color: #333;
      line-height: 1.8;
      font-size: 16px;
    }

    /* Quiz component */
    .quiz {
      background: #fff;
      border: 2px solid #e1e4e8;
      border-radius: 12px;
      padding: 24px;
    }

    .quiz-question {
      font-size: 18px;
      font-weight: 600;
      color: #333;
      margin-bottom: 20px;
    }

    .quiz-options {
      display: flex;
      flex-direction: column;
      gap: 12px;
    }

    .quiz-option {
      padding: 16px 20px;
      border: 2px solid #e1e4e8;
      border-radius: 8px;
      cursor: pointer;
      transition: all 0.2s;
      font-size: 16px;
      background: white;
    }

    .quiz-option:hover {
      border-color: #667eea;
      background: #f8f9ff;
      transform: translateX(5px);
    }

    .quiz-option.selected {
      border-color: #667eea;
      background: #f0f4ff;
      font-weight: 600;
    }

    /* Button component */
    .button {
      padding: 14px 32px;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      border: none;
      border-radius: 8px;
      font-size: 16px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s;
      box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);
    }

    .button:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 20px rgba(102, 126, 234, 0.6);
    }

    .button:active {
      transform: translateY(0);
    }

    /* Animation component */
    .animation-container {
      background: linear-gradient(180deg, #87ceeb 0%, #e0f7ff 100%);
      border-radius: 12px;
      padding: 30px;
      margin: 20px 0;
      min-height: 400px;
      position: relative;
      overflow: hidden;
      box-shadow: inset 0 2px 10px rgba(0,0,0,0.1);
    }

    /* Pisa Tower Scene */
    .pisa-tower {
      position: absolute;
      bottom: 0;
      left: 50%;
      transform: translateX(-50%);
      width: 120px;
      height: 350px;
      background: linear-gradient(to right, #d4a574 0%, #c89666 50%, #b88858 100%);
      border-radius: 8px 8px 0 0;
      box-shadow: 0 5px 20px rgba(0,0,0,0.3);
      transform: translateX(-50%) rotate(4deg);
      transform-origin: bottom center;
    }

    .tower-level {
      position: absolute;
      width: 100%;
      height: 60px;
      border-bottom: 3px solid #996633;
      border-top: 2px solid #edc9a3;
    }

    .tower-level:nth-child(1) { top: 0; }
    .tower-level:nth-child(2) { top: 60px; }
    .tower-level:nth-child(3) { top: 120px; }
    .tower-level:nth-child(4) { top: 180px; }
    .tower-level:nth-child(5) { top: 240px; }

    .ball {
      position: absolute;
      border-radius: 50%;
      box-shadow: 0 4px 8px rgba(0,0,0,0.3);
    }

    .ball.heavy {
      width: 40px;
      height: 40px;
      background: radial-gradient(circle at 30% 30%, #999, #333);
      left: calc(50% - 80px);
      top: 50px;
    }

    .ball.light {
      width: 40px;
      height: 40px;
      background: radial-gradient(circle at 30% 30%, #ff6b6b, #c92a2a);
      left: calc(50% + 40px);
      top: 50px;
    }

    @keyframes fallDown {
      0% {
        top: 50px;
        opacity: 1;
      }
      100% {
        top: 350px;
        opacity: 0.8;
      }
    }

    .ball.falling {
      animation: fallDown 1.5s ease-in forwards;
    }

    .galileo {
      position: absolute;
      top: 30px;
      left: 50%;
      transform: translateX(-50%);
      font-size: 40px;
      z-index: 10;
    }

    /* Earth Scene */
    .earth-system {
      position: relative;
      width: 100%;
      height: 100%;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .sun {
      position: absolute;
      width: 100px;
      height: 100px;
      background: radial-gradient(circle, #ffeb3b 0%, #ff9800 100%);
      border-radius: 50%;
      box-shadow: 0 0 50px #ff9800, 0 0 100px #ff9800;
      animation: sunGlow 3s ease-in-out infinite;
    }

    @keyframes sunGlow {
      0%, 100% {
        box-shadow: 0 0 50px #ff9800, 0 0 100px #ff9800;
      }
      50% {
        box-shadow: 0 0 80px #ff9800, 0 0 130px #ff9800;
      }
    }

    .orbit {
      position: absolute;
      border: 2px dashed rgba(255, 255, 255, 0.3);
      border-radius: 50%;
    }

    .orbit.revolution {
      width: 350px;
      height: 350px;
    }

    .earth-container {
      position: absolute;
      width: 80px;
      height: 80px;
      animation: revolution 10s linear infinite paused;
      transform-origin: 175px center;
      left: calc(50% - 40px);
      top: calc(50% - 215px);
    }

    .earth-container.rotating {
      animation-play-state: running;
    }

    @keyframes revolution {
      from {
        transform: rotate(0deg) translateX(175px) rotate(0deg);
      }
      to {
        transform: rotate(360deg) translateX(175px) rotate(-360deg);
      }
    }

    .earth {
      width: 80px;
      height: 80px;
      background: linear-gradient(135deg, #4a90e2 0%, #2e7d32 50%, #1565c0 100%);
      border-radius: 50%;
      position: relative;
      box-shadow: 0 0 30px rgba(66, 165, 245, 0.5);
      animation: rotation 4s linear infinite paused;
    }

    .earth.rotating {
      animation-play-state: running;
    }

    @keyframes rotation {
      from {
        transform: rotate(0deg);
      }
      to {
        transform: rotate(360deg);
      }
    }

    .earth::after {
      content: '';
      position: absolute;
      top: 10%;
      left: 10%;
      width: 80%;
      height: 80%;
      background: radial-gradient(circle at 30% 30%, rgba(255,255,255,0.3), transparent);
      border-radius: 50%;
    }

    .earth-axis {
      position: absolute;
      width: 2px;
      height: 100px;
      background: rgba(255, 255, 255, 0.6);
      top: -10px;
      left: 39px;
      transform: rotate(23.5deg);
      transform-origin: center;
    }

    .axis-label {
      position: absolute;
      top: -25px;
      left: -30px;
      color: white;
      font-size: 12px;
      white-space: nowrap;
      background: rgba(0,0,0,0.6);
      padding: 2px 6px;
      border-radius: 4px;
    }

    .moon {
      position: absolute;
      width: 20px;
      height: 20px;
      background: radial-gradient(circle, #ddd, #999);
      border-radius: 50%;
      top: -30px;
      left: 30px;
    }

    .info-label {
      position: absolute;
      background: rgba(255, 255, 255, 0.95);
      padding: 12px 16px;
      border-radius: 8px;
      font-size: 14px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.2);
      max-width: 200px;
    }

    .label-revolution {
      bottom: 50px;
      left: 50px;
    }

    .label-rotation {
      bottom: 50px;
      right: 50px;
    }

    /* Interactive Canvas */
    .interactive-canvas {
      position: relative;
      background: #f8f9fa;
      border-radius: 12px;
      padding: 20px;
      margin: 20px 0;
    }

    /* Toast */
    .toast {
      position: fixed;
      top: 20px;
      left: 50%;
      transform: translateX(-50%);
      background: #333;
      color: white;
      padding: 16px 24px;
      border-radius: 8px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
      z-index: 1000;
      animation: slideDown 0.3s ease-out;
      max-width: 400px;
      text-align: center;
    }

    @keyframes slideDown {
      from {
        opacity: 0;
        transform: translateX(-50%) translateY(-20px);
      }
      to {
        opacity: 1;
        transform: translateX(-50%) translateY(0);
      }
    }

    /* Debug panel */
    .debug-section {
      margin-bottom: 20px;
    }

    .debug-title {
      font-size: 14px;
      font-weight: 600;
      color: #667eea;
      margin-bottom: 10px;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .debug-content {
      background: #f8f9fa;
      padding: 12px;
      border-radius: 6px;
      font-family: 'Courier New', monospace;
      font-size: 12px;
      color: #333;
      white-space: pre-wrap;
      word-break: break-all;
      max-height: 200px;
      overflow-y: auto;
    }

    .log-entry {
      padding: 8px;
      margin-bottom: 6px;
      border-radius: 4px;
      background: white;
      border-left: 3px solid #667eea;
      font-size: 11px;
    }

    .log-type {
      font-weight: bold;
      color: #667eea;
      text-transform: uppercase;
      font-size: 10px;
    }

    .log-message {
      color: #666;
      margin-top: 4px;
    }

    .score-display {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      padding: 20px;
      border-radius: 8px;
      text-align: center;
      margin-bottom: 20px;
    }

    .score-label {
      font-size: 12px;
      opacity: 0.9;
      margin-bottom: 5px;
    }

    .score-value {
      font-size: 32px;
      font-weight: bold;
    }

    .scene-info {
      background: #f0f4ff;
      padding: 12px;
      border-radius: 6px;
      margin-bottom: 20px;
      text-align: center;
      color: #667eea;
      font-weight: 600;
      font-size: 14px;
    }

    /* Animation Component */
    .anim-component {
      margin: 20px 0;
    }

    /* Conclusion Box */
    .conclusion {
      background: linear-gradient(135deg, #e8f5e9 0%, #c8e6c9 100%);
      border-left: 4px solid #4caf50;
      padding: 20px;
      border-radius: 12px;
      margin: 20px 0;
    }

    .conclusion-title {
      font-weight: bold;
      color: #2e7d32;
      margin-bottom: 10px;
      font-size: 18px;
    }

    .conclusion-text {
      color: #1b5e20;
      line-height: 1.8;
    }

    /* Thinking Box */
    .thinking {
      background: linear-gradient(135deg, #fff3e0 0%, #ffe0b2 100%);
      border-left: 4px solid #ff9800;
      padding: 20px;
      border-radius: 12px;
      margin: 20px 0;
    }

    .thinking-title {
      font-weight: bold;
      color: #e65100;
      margin-bottom: 10px;
      font-size: 18px;
    }

    .thinking-text {
      color: #bf360c;
      line-height: 1.8;
    }

    /* Control buttons */
    .control-buttons {
      display: flex;
      gap: 12px;
      margin: 20px 0;
      flex-wrap: wrap;
    }

    .control-button {
      padding: 12px 24px;
      background: white;
      color: #667eea;
      border: 2px solid #667eea;
      border-radius: 8px;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s;
    }

    .control-button:hover {
      background: #667eea;
      color: white;
      transform: translateY(-2px);
    }

    .control-button.active {
      background: #667eea;
      color: white;
    }
  </style>
</head>
<body>
  <div class="container">
    <!-- Main content area -->
    <div class="main-panel">
      <h1>ğŸ“ VVè¯¾å ‚ - æ²‰æµ¸å¼äº¤äº’è¯¾ä»¶</h1>
      <p class="subtitle">ä½“éªŒç‰©ç†å®éªŒä¸åœ°ç†æ¢ç´¢çš„å¥‡å¦™ä¹‹æ—…</p>

      <div id="scene-container" class="scene"></div>
    </div>

    <!-- Debug panel -->
    <div class="debug-panel">
      <div class="debug-section">
        <div class="debug-title">ğŸ“Š å½“å‰çŠ¶æ€</div>
        <div class="scene-info" id="current-scene">åœºæ™¯: åŠ è½½ä¸­...</div>

        <div class="score-display">
          <div class="score-label">æ¢ç´¢ç§¯åˆ†</div>
          <div class="score-value" id="score-display">0</div>
        </div>
      </div>

      <div class="debug-section">
        <div class="debug-title">ğŸ”§ å…¨å±€å˜é‡</div>
        <div class="debug-content" id="global-vars"></div>
      </div>

      <div class="debug-section">
        <div class="debug-title">ğŸ“ æœ€è¿‘æ—¥å¿—</div>
        <div id="logs-container"></div>
      </div>
    </div>
  </div>

  <script type="module">
    import { VVCERuntime } from '../../packages/vvce-core/dist/index.mjs';

    // Immersive course DSL
    const immersiveCourse = {
      schema: 'vvce.dsl.v1',
      meta: {
        id: 'immersive-science-course',
        version: '1.0.0',
        title: 'æ²‰æµ¸å¼ç§‘å­¦è¯¾å ‚',
        author: 'VV Education'
      },
      globals: {
        vars: {
          score: 0,
          studentName: 'åŒå­¦',
          pisaAnswered: false,
          earthAnswered: false
        }
      },
      startSceneId: 'welcome',
      scenes: [
        // Welcome Scene
        {
          id: 'welcome',
          nodes: [
            {
              id: 'welcome-dialog',
              type: 'Dialog',
              props: {
                speaker: 'VVæ•™æˆ',
                text: 'æ¬¢è¿æ¥åˆ°VVè¯¾å ‚ï¼ä»Šå¤©æˆ‘ä»¬å°†é€šè¿‡æ²‰æµ¸å¼ä½“éªŒï¼Œæ¢ç´¢ç‰©ç†å’Œåœ°ç†çš„å¥¥ç§˜ã€‚å‡†å¤‡å¥½äº†å—ï¼Ÿ'
              }
            },
            {
              id: 'course-menu',
              type: 'Dialog',
              props: {
                speaker: 'VVæ•™æˆ',
                text: 'è¯·é€‰æ‹©ä½ æƒ³æ¢ç´¢çš„ä¸»é¢˜ï¼š'
              }
            },
            {
              id: 'btn-pisa',
              type: 'Button',
              props: {
                text: 'ğŸ›ï¸ ä¼½åˆ©ç•¥çš„æ¯”è¨æ–œå¡”å®éªŒ'
              }
            },
            {
              id: 'btn-earth',
              type: 'Button',
              props: {
                text: 'ğŸŒ åœ°çƒçš„å…¬è½¬ä¸è‡ªè½¬'
              }
            }
          ],
          triggers: [
            {
              on: { event: 'click', target: 'btn-pisa' },
              then: [
                { action: 'gotoScene', sceneId: 'pisa-intro' }
              ]
            },
            {
              on: { event: 'click', target: 'btn-earth' },
              then: [
                { action: 'gotoScene', sceneId: 'earth-intro' }
              ]
            }
          ]
        },

        // Pisa Experiment - Introduction
        {
          id: 'pisa-intro',
          nodes: [
            {
              id: 'pisa-intro-dialog',
              type: 'Dialog',
              props: {
                speaker: 'VVæ•™æˆ',
                text: 'è®©æˆ‘ä»¬ç©¿è¶Šåˆ°1589å¹´çš„æ„å¤§åˆ©æ¯”è¨ã€‚ä¼ è¯´ä¼½åˆ©ç•¥åœ¨æ¯”è¨æ–œå¡”ä¸Šåšäº†ä¸€ä¸ªè‘—åçš„å®éªŒ...'
              }
            },
            {
              id: 'pisa-story',
              type: 'Dialog',
              props: {
                speaker: 'VVæ•™æˆ',
                text: 'ä»–åŒæ—¶é‡Šæ”¾äº†ä¸€ä¸ªé‡é“çƒå’Œä¸€ä¸ªè½»é“çƒã€‚åœ¨å½“æ—¶ï¼Œäººä»¬æ™®éç›¸ä¿¡äºšé‡Œå£«å¤šå¾·çš„ç†è®ºï¼šé‡ç‰©ä¸‹è½å¾—æ›´å¿«ã€‚'
              }
            },
            {
              id: 'btn-next-pisa',
              type: 'Button',
              props: {
                text: 'ç»§ç»­æ¢ç´¢ â†’'
              }
            }
          ],
          triggers: [
            {
              on: { event: 'click', target: 'btn-next-pisa' },
              then: [
                { action: 'gotoScene', sceneId: 'pisa-question' }
              ]
            }
          ]
        },

        // Pisa Experiment - Question
        {
          id: 'pisa-question',
          nodes: [
            {
              id: 'pisa-question-dialog',
              type: 'Dialog',
              props: {
                speaker: 'VVæ•™æˆ',
                text: 'ç°åœ¨ï¼Œæˆ‘ä»¬æ¥é‡ç°è¿™ä¸ªå®éªŒï¼è¯·çœ‹æ¯”è¨æ–œå¡”é¡¶ç«¯çš„ä¸¤ä¸ªé“çƒã€‚'
              }
            },
            {
              id: 'pisa-animation',
              type: 'Animation',
              props: {
                type: 'pisa-tower',
                autoplay: false
              }
            },
            {
              id: 'pisa-quiz',
              type: 'QuizSingle',
              props: {
                question: 'å¦‚æœåŒæ—¶é‡Šæ”¾ï¼Œä½ è®¤ä¸ºä¼šå‘ç”Ÿä»€ä¹ˆï¼Ÿ',
                options: [
                  'é‡çƒå…ˆè½åœ°',
                  'è½»çƒå…ˆè½åœ°',
                  'ä¸¤çƒåŒæ—¶è½åœ°',
                  'æ— æ³•é¢„æµ‹'
                ]
              }
            },
            {
              id: 'btn-run-experiment',
              type: 'Button',
              props: {
                text: 'ğŸ”¬ å¼€å§‹å®éªŒ'
              }
            }
          ],
          triggers: [
            {
              on: { event: 'click', target: 'btn-run-experiment' },
              if: [
                {
                  op: 'equals',
                  left: { ref: 'nodes.pisa-quiz.selected' },
                  right: 'ä¸¤çƒåŒæ—¶è½åœ°'
                }
              ],
              then: [
                { action: 'setVar', path: 'globals.vars.pisaAnswered', value: true },
                { action: 'addScore', value: 30 },
                { action: 'toast', text: 'å¤ªæ£’äº†ï¼è®©æˆ‘ä»¬çœ‹çœ‹å®éªŒç»“æœ...' },
                { action: 'delay', ms: 2000 },
                { action: 'gotoScene', sceneId: 'pisa-result-correct' }
              ],
              else: [
                { action: 'setVar', path: 'globals.vars.pisaAnswered', value: true },
                { action: 'toast', text: 'æ²¡å…³ç³»ï¼Œè®©æˆ‘ä»¬é€šè¿‡å®éªŒæ¥éªŒè¯...' },
                { action: 'delay', ms: 2000 },
                { action: 'gotoScene', sceneId: 'pisa-result-wrong' }
              ]
            }
          ]
        },

        // Pisa Result - Correct Answer
        {
          id: 'pisa-result-correct',
          nodes: [
            {
              id: 'pisa-result-anim',
              type: 'Animation',
              props: {
                type: 'pisa-tower',
                autoplay: true
              }
            },
            {
              id: 'pisa-correct-dialog',
              type: 'Dialog',
              props: {
                speaker: 'VVæ•™æˆ',
                text: 'æ­å–œä½ ï¼ä½ çš„ç›´è§‰æ˜¯å¯¹çš„ã€‚çœ‹ï¼Œä¸¤ä¸ªé“çƒç¡®å®åŒæ—¶è½åœ°äº†ï¼'
              }
            },
            {
              id: 'pisa-conclusion',
              type: 'Conclusion',
              props: {
                title: 'ğŸ¯ ç§‘å­¦ç»“è®º',
                text: 'åœ¨å¿½ç•¥ç©ºæ°”é˜»åŠ›çš„æƒ…å†µä¸‹ï¼Œä¸åŒè´¨é‡çš„ç‰©ä½“ä¸‹è½é€Ÿåº¦ç›¸åŒã€‚è¿™æ¨ç¿»äº†äºšé‡Œå£«å¤šå¾·æŒç»­äº†è¿‘2000å¹´çš„ç†è®ºï¼Œæ˜¯ç§‘å­¦å²ä¸Šçš„é‡è¦çªç ´ï¼'
              }
            },
            {
              id: 'pisa-thinking',
              type: 'Thinking',
              props: {
                title: 'ğŸ’­ æ·±å…¥æ€è€ƒ',
                text: 'ä¸ºä»€ä¹ˆåœ¨çœŸå®ä¸–ç•Œä¸­ï¼Œä¸€ç‰‡ç¾½æ¯›å’Œä¸€ä¸ªé“çƒä¸‹è½é€Ÿåº¦ä¸åŒå‘¢ï¼Ÿæç¤ºï¼šæƒ³æƒ³ç©ºæ°”é˜»åŠ›çš„ä½œç”¨...'
              }
            },
            {
              id: 'btn-back-menu',
              type: 'Button',
              props: {
                text: 'è¿”å›ä¸»èœå•'
              }
            }
          ],
          triggers: [
            {
              on: { event: 'click', target: 'btn-back-menu' },
              then: [
                { action: 'gotoScene', sceneId: 'welcome' }
              ]
            }
          ]
        },

        // Pisa Result - Wrong Answer
        {
          id: 'pisa-result-wrong',
          nodes: [
            {
              id: 'pisa-result-anim-wrong',
              type: 'Animation',
              props: {
                type: 'pisa-tower',
                autoplay: true
              }
            },
            {
              id: 'pisa-wrong-dialog',
              type: 'Dialog',
              props: {
                speaker: 'VVæ•™æˆ',
                text: 'çœ‹ï¼å®éªŒçš„ç»“æœå¯èƒ½è®©ä½ æƒŠè®¶â€”â€”ä¸¤ä¸ªé“çƒç«Ÿç„¶åŒæ—¶è½åœ°äº†ï¼'
              }
            },
            {
              id: 'pisa-conclusion-wrong',
              type: 'Conclusion',
              props: {
                title: 'ğŸ¯ ç§‘å­¦ç»“è®º',
                text: 'åœ¨å¿½ç•¥ç©ºæ°”é˜»åŠ›çš„æƒ…å†µä¸‹ï¼Œä¸åŒè´¨é‡çš„ç‰©ä½“ä¸‹è½é€Ÿåº¦ç›¸åŒã€‚è¿™ä¸ªç»“è®ºé¢ è¦†äº†å¾ˆå¤šäººçš„ç›´è§‰ï¼Œä¹Ÿæ˜¯ä¼½åˆ©ç•¥å¯¹ç§‘å­¦çš„é‡å¤§è´¡çŒ®ï¼'
              }
            },
            {
              id: 'pisa-thinking-wrong',
              type: 'Thinking',
              props: {
                title: 'ğŸ’­ ä¸ºä»€ä¹ˆæˆ‘ä»¬çš„ç›´è§‰ä¼šé”™ï¼Ÿ',
                text: 'æ—¥å¸¸ç”Ÿæ´»ä¸­ï¼Œæˆ‘ä»¬çœ‹åˆ°é‡ç‰©ç¡®å®ä¸‹è½æ›´å¿«ï¼ˆæ¯”å¦‚çŸ³å¤´vsç¾½æ¯›ï¼‰ã€‚ä½†é‚£æ˜¯å› ä¸ºç©ºæ°”é˜»åŠ›çš„å½±å“ï¼åœ¨çœŸç©ºä¸­ï¼Œç¾½æ¯›å’Œé“çƒä¸‹è½é€Ÿåº¦æ˜¯ä¸€æ ·çš„ã€‚è¿™å°±æ˜¯ä¸ºä»€ä¹ˆç§‘å­¦å®éªŒå¦‚æ­¤é‡è¦ã€‚'
              }
            },
            {
              id: 'btn-back-menu-wrong',
              type: 'Button',
              props: {
                text: 'è¿”å›ä¸»èœå•'
              }
            }
          ],
          triggers: [
            {
              on: { event: 'click', target: 'btn-back-menu-wrong' },
              then: [
                { action: 'gotoScene', sceneId: 'welcome' }
              ]
            }
          ]
        },

        // Earth - Introduction
        {
          id: 'earth-intro',
          nodes: [
            {
              id: 'earth-intro-dialog',
              type: 'Dialog',
              props: {
                speaker: 'VVæ•™æˆ',
                text: 'æ¬¢è¿æ¥åˆ°åœ°çƒç§‘å­¦è¯¾å ‚ï¼åœ°çƒæ˜¯ä¸€é¢—ç¥å¥‡çš„æ˜Ÿçƒï¼Œå®ƒæœ‰ä¸¤ç§é‡è¦çš„è¿åŠ¨æ–¹å¼ã€‚'
              }
            },
            {
              id: 'earth-explain',
              type: 'Dialog',
              props: {
                speaker: 'VVæ•™æˆ',
                text: 'åœ°çƒå›´ç»•å¤ªé˜³è½¬åŠ¨ï¼ˆå…¬è½¬ï¼‰ï¼ŒåŒæ—¶ä¹Ÿåœ¨è‡ªå·±çš„è½´ä¸Šæ—‹è½¬ï¼ˆè‡ªè½¬ï¼‰ã€‚è¿™ä¸¤ç§è¿åŠ¨é€ å°±äº†æˆ‘ä»¬çš„æ˜¼å¤œäº¤æ›¿å’Œå››å­£å˜åŒ–ã€‚'
              }
            },
            {
              id: 'btn-next-earth',
              type: 'Button',
              props: {
                text: 'å¼€å§‹æ¢ç´¢ â†’'
              }
            }
          ],
          triggers: [
            {
              on: { event: 'click', target: 'btn-next-earth' },
              then: [
                { action: 'gotoScene', sceneId: 'earth-interactive' }
              ]
            }
          ]
        },

        // Earth - Interactive
        {
          id: 'earth-interactive',
          nodes: [
            {
              id: 'earth-interactive-dialog',
              type: 'Dialog',
              props: {
                speaker: 'VVæ•™æˆ',
                text: 'è®©æˆ‘ä»¬é€šè¿‡äº’åŠ¨æ¨¡æ‹Ÿæ¥ç†è§£åœ°çƒçš„è¿åŠ¨ï¼ç‚¹å‡»ä¸‹é¢çš„æŒ‰é’®æ§åˆ¶åœ°çƒçš„è¿åŠ¨ã€‚'
              }
            },
            {
              id: 'earth-animation',
              type: 'Animation',
              props: {
                type: 'earth-system',
                autoplay: false
              }
            },
            {
              id: 'earth-controls',
              type: 'Controls',
              props: {
                buttons: [
                  { id: 'btn-rotation', text: 'å¯åŠ¨è‡ªè½¬' },
                  { id: 'btn-revolution', text: 'å¯åŠ¨å…¬è½¬' },
                  { id: 'btn-both', text: 'åŒæ—¶è¿åŠ¨' },
                  { id: 'btn-stop', text: 'åœæ­¢' }
                ]
              }
            },
            {
              id: 'earth-quiz',
              type: 'QuizSingle',
              props: {
                question: 'åœ°çƒè‡ªè½¬ä¸€å‘¨éœ€è¦å¤šé•¿æ—¶é—´ï¼Ÿ',
                options: [
                  '12å°æ—¶',
                  '24å°æ—¶',
                  '365å¤©',
                  'ä¸€ä¸ªæœˆ'
                ]
              }
            },
            {
              id: 'btn-submit-earth',
              type: 'Button',
              props: {
                text: 'æäº¤ç­”æ¡ˆ'
              }
            }
          ],
          triggers: [
            {
              on: { event: 'click', target: 'btn-submit-earth' },
              if: [
                {
                  op: 'equals',
                  left: { ref: 'nodes.earth-quiz.selected' },
                  right: '24å°æ—¶'
                }
              ],
              then: [
                { action: 'addScore', value: 30 },
                { action: 'toast', text: 'å®Œå…¨æ­£ç¡®ï¼' },
                { action: 'delay', ms: 1500 },
                { action: 'gotoScene', sceneId: 'earth-conclusion' }
              ],
              else: [
                { action: 'toast', text: 'å†æƒ³æƒ³ï¼Œè§‚å¯Ÿä¸€ä¸‹åœ°çƒçš„è‡ªè½¬åŠ¨ç”»...' }
              ]
            }
          ]
        },

        // Earth - Conclusion
        {
          id: 'earth-conclusion',
          nodes: [
            {
              id: 'earth-conclusion-dialog',
              type: 'Dialog',
              props: {
                speaker: 'VVæ•™æˆ',
                text: 'å¤ªæ£’äº†ï¼è®©æˆ‘ä»¬æ€»ç»“ä¸€ä¸‹åœ°çƒè¿åŠ¨çš„çŸ¥è¯†ã€‚'
              }
            },
            {
              id: 'earth-final-anim',
              type: 'Animation',
              props: {
                type: 'earth-system',
                autoplay: true
              }
            },
            {
              id: 'earth-conclusion-box',
              type: 'Conclusion',
              props: {
                title: 'ğŸŒ åœ°çƒè¿åŠ¨æ€»ç»“',
                text: '1ï¸âƒ£ è‡ªè½¬ï¼šåœ°çƒç»•è‡ªå·±çš„è½´æ—‹è½¬ï¼Œå‘¨æœŸçº¦24å°æ—¶ï¼Œé€ æˆæ˜¼å¤œäº¤æ›¿\n2ï¸âƒ£ å…¬è½¬ï¼šåœ°çƒç»•å¤ªé˜³è¿åŠ¨ï¼Œå‘¨æœŸçº¦365å¤©ï¼Œé€ æˆå››å­£å˜åŒ–\n3ï¸âƒ£ åœ°è½´å€¾æ–œ23.5Â°ï¼šè¿™æ˜¯å››å­£å½¢æˆçš„å…³é”®å› ç´ '
              }
            },
            {
              id: 'earth-thinking-box',
              type: 'Thinking',
              props: {
                title: 'ğŸ’­ æœ‰è¶£çš„é—®é¢˜',
                text: 'å¦‚æœåœ°çƒä¸è‡ªè½¬ä¼šæ€æ ·ï¼Ÿä¸€é¢æ°¸è¿œæ˜¯ç™½å¤©ï¼Œä¸€é¢æ°¸è¿œæ˜¯é»‘å¤œï¼é‚£ä¼šæ˜¯ä»€ä¹ˆæ ·çš„ä¸–ç•Œå‘¢ï¼Ÿ'
              }
            },
            {
              id: 'btn-back-final',
              type: 'Button',
              props: {
                text: 'è¿”å›ä¸»èœå•'
              }
            },
            {
              id: 'btn-finish',
              type: 'Button',
              props: {
                text: 'å®Œæˆæ‰€æœ‰è¯¾ç¨‹ ğŸ‰'
              }
            }
          ],
          triggers: [
            {
              on: { event: 'click', target: 'btn-back-final' },
              then: [
                { action: 'gotoScene', sceneId: 'welcome' }
              ]
            },
            {
              on: { event: 'click', target: 'btn-finish' },
              then: [
                { action: 'gotoScene', sceneId: 'final' }
              ]
            }
          ]
        },

        // Final Scene
        {
          id: 'final',
          nodes: [
            {
              id: 'final-dialog',
              type: 'Dialog',
              props: {
                speaker: 'VVæ•™æˆ',
                text: 'æ­å–œä½ å®Œæˆäº†è¿™æ¬¡æ²‰æµ¸å¼ç§‘å­¦æ¢ç´¢ä¹‹æ—…ï¼ä½ çš„æœ€ç»ˆå¾—åˆ†æ˜¯ï¼š{{globals.vars.score}}åˆ†'
              }
            },
            {
              id: 'final-summary',
              type: 'Conclusion',
              props: {
                title: 'ğŸ“ å­¦ä¹ æ€»ç»“',
                text: 'ä»Šå¤©æˆ‘ä»¬å­¦ä¹ äº†ï¼š\nâœ… ä¼½åˆ©ç•¥çš„è‡ªç”±è½ä½“å®éªŒ\nâœ… ç§‘å­¦æ–¹æ³•çš„é‡è¦æ€§\nâœ… åœ°çƒçš„è‡ªè½¬å’Œå…¬è½¬\nâœ… å¤©æ–‡ç°è±¡èƒŒåçš„åŸç†'
              }
            },
            {
              id: 'btn-restart',
              type: 'Button',
              props: {
                text: 'é‡æ–°å¼€å§‹æ¢ç´¢'
              }
            }
          ],
          triggers: [
            {
              on: { event: 'click', target: 'btn-restart' },
              then: [
                { action: 'setVar', path: 'globals.vars.score', value: 0 },
                { action: 'gotoScene', sceneId: 'welcome' }
              ]
            }
          ]
        }
      ]
    };

    // Component Renderers
    class ComponentRenderer {
      constructor(runtime) {
        this.runtime = runtime;
        this.nodeStates = new Map();
        this.animations = new Map();
      }

      renderDialog(node) {
        const { speaker, text } = node.props;
        const processedText = this.interpolateText(text);

        return `
          <div class="node dialog" data-node-id="${node.id}">
            ${speaker ? `<div class="dialog-speaker">${speaker}</div>` : ''}
            <div class="dialog-text">${processedText}</div>
          </div>
        `;
      }

      renderQuizSingle(node) {
        const { question, options } = node.props;
        const selected = this.nodeStates.get(node.id) || null;

        const optionsHtml = options.map((option, index) => {
          const isSelected = selected === option;
          return `
            <div class="quiz-option ${isSelected ? 'selected' : ''}"
                 data-node-id="${node.id}"
                 data-option="${option}">
              ${String.fromCharCode(65 + index)}. ${option}
            </div>
          `;
        }).join('');

        return `
          <div class="node quiz" data-node-id="${node.id}">
            <div class="quiz-question">${question}</div>
            <div class="quiz-options">
              ${optionsHtml}
            </div>
          </div>
        `;
      }

      renderButton(node) {
        const { text } = node.props;
        return `
          <div class="node">
            <button class="button" data-node-id="${node.id}">
              ${text}
            </button>
          </div>
        `;
      }

      renderAnimation(node) {
        const { type, autoplay } = node.props;

        if (type === 'pisa-tower') {
          return `
            <div class="node anim-component" data-node-id="${node.id}">
              <div class="animation-container" id="pisa-container">
                <div class="pisa-tower">
                  <div class="tower-level"></div>
                  <div class="tower-level"></div>
                  <div class="tower-level"></div>
                  <div class="tower-level"></div>
                  <div class="tower-level"></div>
                </div>
                <div class="galileo">ğŸ§‘â€ğŸ”¬</div>
                <div class="ball heavy" id="heavy-ball"></div>
                <div class="ball light" id="light-ball"></div>
              </div>
            </div>
          `;
        } else if (type === 'earth-system') {
          return `
            <div class="node anim-component" data-node-id="${node.id}">
              <div class="animation-container" style="background: linear-gradient(180deg, #000428 0%, #004e92 100%);">
                <div class="earth-system">
                  <div class="sun"></div>
                  <div class="orbit revolution"></div>
                  <div class="earth-container" id="earth-orbit">
                    <div class="earth" id="earth-rotate">
                      <div class="earth-axis">
                        <div class="axis-label">23.5Â°</div>
                      </div>
                      <div class="moon"></div>
                    </div>
                  </div>
                  <div class="info-label label-revolution">
                    <strong>å…¬è½¬</strong><br>
                    å‘¨æœŸï¼š365å¤©
                  </div>
                  <div class="info-label label-rotation">
                    <strong>è‡ªè½¬</strong><br>
                    å‘¨æœŸï¼š24å°æ—¶
                  </div>
                </div>
              </div>
            </div>
          `;
        }
        return '';
      }

      renderControls(node) {
        const { buttons } = node.props;

        const buttonsHtml = buttons.map(btn => `
          <button class="control-button"
                  data-node-id="${node.id}"
                  data-control="${btn.id}">
            ${btn.text}
          </button>
        `).join('');

        return `
          <div class="node control-buttons" data-node-id="${node.id}">
            ${buttonsHtml}
          </div>
        `;
      }

      renderConclusion(node) {
        const { title, text } = node.props;
        return `
          <div class="node conclusion" data-node-id="${node.id}">
            <div class="conclusion-title">${title}</div>
            <div class="conclusion-text">${text.replace(/\n/g, '<br>')}</div>
          </div>
        `;
      }

      renderThinking(node) {
        const { title, text } = node.props;
        return `
          <div class="node thinking" data-node-id="${node.id}">
            <div class="thinking-title">${title}</div>
            <div class="thinking-text">${text}</div>
          </div>
        `;
      }

      interpolateText(text) {
        return text.replace(/\{\{(.+?)\}\}/g, (match, path) => {
          const trimmedPath = path.trim();
          const parts = trimmedPath.split('.');
          const varName = parts[parts.length - 1];
          const value = this.runtime.getState().globals.vars[varName];
          return value !== undefined ? value : match;
        });
      }

      renderNode(node) {
        switch (node.type) {
          case 'Dialog':
            return this.renderDialog(node);
          case 'QuizSingle':
            return this.renderQuizSingle(node);
          case 'Button':
            return this.renderButton(node);
          case 'Animation':
            return this.renderAnimation(node);
          case 'Controls':
            return this.renderControls(node);
          case 'Conclusion':
            return this.renderConclusion(node);
          case 'Thinking':
            return this.renderThinking(node);
          default:
            return `<div class="node">Unknown component: ${node.type}</div>`;
        }
      }
    }

    // UI Manager
    class UIManager {
      constructor(runtime, renderer) {
        this.runtime = runtime;
        this.renderer = renderer;
        this.sceneContainer = document.getElementById('scene-container');
        this.setupEventListeners();
      }

      setupEventListeners() {
        this.sceneContainer.addEventListener('click', (e) => {
          const target = e.target;

          // Handle button clicks
          if (target.classList.contains('button')) {
            const nodeId = target.dataset.nodeId;
            this.runtime.emit({
              type: 'click',
              target: nodeId,
              payload: null,
              ts: Date.now()
            });
          }

          // Handle quiz option clicks
          if (target.classList.contains('quiz-option')) {
            const nodeId = target.dataset.nodeId;
            const option = target.dataset.option;

            const allOptions = this.sceneContainer.querySelectorAll(
              `.quiz-option[data-node-id="${nodeId}"]`
            );
            allOptions.forEach(opt => opt.classList.remove('selected'));
            target.classList.add('selected');

            this.renderer.nodeStates.set(nodeId, option);
            this.runtime.updateNodeState(nodeId, { selected: option });

            this.runtime.emit({
              type: 'change',
              target: nodeId,
              payload: option,
              ts: Date.now()
            });
          }

          // Handle control buttons
          if (target.classList.contains('control-button')) {
            const controlId = target.dataset.control;

            // Remove active class from all buttons
            const allButtons = this.sceneContainer.querySelectorAll('.control-button');
            allButtons.forEach(btn => btn.classList.remove('active'));
            target.classList.add('active');

            // Control animations
            const earthOrbit = document.getElementById('earth-orbit');
            const earthRotate = document.getElementById('earth-rotate');

            if (earthOrbit && earthRotate) {
              switch (controlId) {
                case 'btn-rotation':
                  earthOrbit.classList.remove('rotating');
                  earthRotate.classList.add('rotating');
                  break;
                case 'btn-revolution':
                  earthOrbit.classList.add('rotating');
                  earthRotate.classList.remove('rotating');
                  break;
                case 'btn-both':
                  earthOrbit.classList.add('rotating');
                  earthRotate.classList.add('rotating');
                  break;
                case 'btn-stop':
                  earthOrbit.classList.remove('rotating');
                  earthRotate.classList.remove('rotating');
                  break;
              }
            }
          }
        });
      }

      renderScene(scene) {
        if (!scene || !scene.nodes) {
          this.sceneContainer.innerHTML = '<p>åœºæ™¯åŠ è½½ä¸­...</p>';
          return;
        }

        const html = scene.nodes.map(node => this.renderer.renderNode(node)).join('');
        this.sceneContainer.innerHTML = html;

        // Auto-play animations if needed
        setTimeout(() => {
          scene.nodes.forEach(node => {
            if (node.type === 'Animation' && node.props.autoplay) {
              if (node.props.type === 'pisa-tower') {
                this.playPisaAnimation();
              } else if (node.props.type === 'earth-system') {
                const earthOrbit = document.getElementById('earth-orbit');
                const earthRotate = document.getElementById('earth-rotate');
                if (earthOrbit && earthRotate) {
                  earthOrbit.classList.add('rotating');
                  earthRotate.classList.add('rotating');
                }
              }
            }
          });
        }, 100);
      }

      playPisaAnimation() {
        const heavyBall = document.getElementById('heavy-ball');
        const lightBall = document.getElementById('light-ball');

        if (heavyBall && lightBall) {
          // Reset positions
          heavyBall.classList.remove('falling');
          lightBall.classList.remove('falling');

          setTimeout(() => {
            heavyBall.classList.add('falling');
            lightBall.classList.add('falling');
          }, 500);
        }
      }

      showToast(text) {
        const existing = document.querySelector('.toast');
        if (existing) {
          existing.remove();
        }

        const toast = document.createElement('div');
        toast.className = 'toast';
        toast.textContent = text;
        document.body.appendChild(toast);

        setTimeout(() => {
          toast.remove();
        }, 3000);
      }

      updateDebugPanel() {
        const state = this.runtime.getState();

        document.getElementById('current-scene').textContent =
          `åœºæ™¯: ${state.scene.current || 'æœªçŸ¥'}`;

        document.getElementById('score-display').textContent =
          state.globals.vars.score || 0;

        document.getElementById('global-vars').textContent =
          JSON.stringify(state.globals.vars, null, 2);

        const logs = this.runtime.getLogs().slice(-8).reverse();
        const logsHtml = logs.map(log => `
          <div class="log-entry">
            <div class="log-type">${log.type}</div>
            <div class="log-message">${log.message}</div>
          </div>
        `).join('');
        document.getElementById('logs-container').innerHTML = logsHtml;
      }
    }

    // Initialize application
    function init() {
      const runtime = new VVCERuntime({
        debug: true,
        onSceneChange: (sceneId) => {
          console.log('Scene changed to:', sceneId);
          const currentScene = runtime.course.scenes.find(s => s.id === sceneId);
          uiManager.renderScene(currentScene);
          uiManager.updateDebugPanel();
        },
        onStateChange: (state) => {
          console.log('State changed:', state);
          uiManager.updateDebugPanel();
        },
        onUIAction: (action) => {
          console.log('UI Action:', action);
          if (action.action === 'toast') {
            uiManager.showToast(action.text);
          }
          uiManager.updateDebugPanel();
        }
      });

      const renderer = new ComponentRenderer(runtime);
      const uiManager = new UIManager(runtime, renderer);

      runtime.loadCourse(immersiveCourse);
      runtime.start();

      const startScene = runtime.course.scenes.find(s => s.id === runtime.course.startSceneId);
      uiManager.renderScene(startScene);
      uiManager.updateDebugPanel();

      window.vvceRuntime = runtime;
      window.uiManager = uiManager;

      console.log('ğŸ“ VV Immersive Course initialized!');
    }

    init();
  </script>
</body>
</html>
